#!/usr/bin/env node
const { load } = require('../index')
const rl = require('readline')

const progress = (c, t) => {
	const total_len = t.toString().length
	const cur = c.toString().padStart(total_len)
	const pct = (c / t * 100 | 0).toString().padStart(3)
	rl.cursorTo(process.stdout, 0)
	rl.clearLine(process.stdout, 0)
	process.stdout.write(`Loaded: ${cur} / ${t} (${pct}%)`)
}

const options = [
    'key',
    'factory',
    'filename',
    'multicall_size',
    'from',
    'to',
    'workers',
    'update_timeout'
]

const params = { progress }
var i = 2
while (arg = process.argv[i]) {
    if (arg == '-h' || arg == '--help') {
        console.log('Options:\n', options.map(option => `\t--${option}`).join('\n'))
        process.exit(0)
    }
    if (!arg.startsWith('--')) {
        console.log(`Option should start with "--", not: "${arg}".`)
        process.exit(22)
    }
    var [option, value] = arg.slice(2).split('=')
    if (!options.includes(option)) {
        console.log(`Unsupported option: "${option}`)
        process.exit(22)
    }
    if (!value) {
        i++
        value = process.argv[i]
        if (!value || value.startsWith('--')) {
            console.log(`Missed value for an option "${option}".`)
            process.exit(22)
        }
    }
    params[option] = value
    i++
}

load(params)
